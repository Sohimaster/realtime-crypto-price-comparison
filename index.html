<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Real-Time Crypto Price Comparison</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- Use a nice Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Open Sans', sans-serif;
    background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    color: #333;
  }

  header {
    background: rgba(255, 255, 255, 0.85);
    padding: 20px;
    text-align: center;
    position: sticky;
    top: 0;
    backdrop-filter: blur(5px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    z-index: 10;
  }

  header h1 {
    margin: 0;
    font-weight: 600;
  }

  .container {
    max-width: 900px;
    margin: 40px auto;
    display: flex;
    flex-direction: column;
    gap: 30px;
    padding: 0 20px;
  }

  .pair-select-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    position: relative;
  }

  /* Custom dropdown styles */
  .pair-dropdown {
    position: relative;
    width: 300px;
  }

  .pair-dropdown-button {
    width: 100%;
    background: #fff;
    border: none;
    padding: 10px 12px;
    font-size: 1em;
    border-radius: 25px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    text-align: left;
    cursor: pointer;
    position: relative;
    font-family: 'Open Sans', sans-serif;
  }

  .pair-dropdown-button::after {
    content: 'â–¼';
    font-size: 0.8em;
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
  }

  .pair-dropdown-panel {
    position: absolute;
    top: 110%;
    left: 0;
    width: 100%;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-radius: 10px;
    overflow: hidden;
    display: none;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    z-index: 20;
  }

  .pair-dropdown-panel.open {
    display: flex;
  }

  .pair-dropdown-search {
    width: 100%;
  }

  .pair-dropdown-search input {
    width: 100%;
    padding: 8px 12px;
    font-size: 1em;
    border-radius: 25px;
    border: none;
    outline: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .pair-dropdown-list {
    max-height: 200px;
    overflow-y: auto;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .pair-dropdown-list li {
    padding: 8px 12px;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .pair-dropdown-list li:hover {
    background: #f0f0f0;
  }

  .exchanges {
    display: flex;
    flex-direction: row;
    gap: 30px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .exchange {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    flex: 1 1 250px;
    min-width: 250px;
    padding: 20px;
    text-align: center;
    transition: background 0.3s ease;
  }

  .exchange:hover {
    background: rgba(255, 255, 255, 0.95);
  }

  .exchange h2 {
    margin-top: 0;
    font-weight: 600;
    letter-spacing: 1px;
    color: #555;
  }

  .price {
    font-size: 2.5em;
    font-weight: 600;
    margin: 10px 0;
    transition: color 0.3s ease;
    word-wrap: break-word;
  }

  .footer-note {
    text-align: center;
    font-size: 0.9em;
    color: #444;
    opacity: 0.8;
  }
</style>
</head>
<body>
<header>
  <h1>Real-Time Crypto Price Comparison</h1>
</header>

<div class="container">
  <div class="pair-select-container">
    <div class="pair-dropdown" id="pair-dropdown">
      <button class="pair-dropdown-button" id="pair-dropdown-button">Loading pairs...</button>
      <div class="pair-dropdown-panel" id="pair-dropdown-panel">
        <div class="pair-dropdown-search">
          <input type="text" id="search-input" placeholder="Search pair..." />
        </div>
        <ul class="pair-dropdown-list" id="pair-list"></ul>
      </div>
    </div>
  </div>

  <div class="exchanges">
    <div class="exchange" id="bybit">
      <h2>Bybit</h2>
      <p class="price" id="bybit-price">Loading...</p>
    </div>
    <div class="exchange" id="binance">
      <h2>Binance</h2>
      <p class="price" id="binance-price">Loading...</p>
    </div>
  </div>
  <p class="footer-note">Prices update in real-time. Colors indicate change from 5 seconds ago: Green = higher, Red = lower.</p>
</div>

<script>
  const bybitPriceEl = document.getElementById("bybit-price");
  const binancePriceEl = document.getElementById("binance-price");
  const dropdownButton = document.getElementById("pair-dropdown-button");
  const dropdownPanel = document.getElementById("pair-dropdown-panel");
  const pairListEl = document.getElementById("pair-list");
  const searchInput = document.getElementById("search-input");

  let bybitCurrentNumeric = null;
  let bybitOldNumeric = null; 
  let binanceCurrentNumeric = null;
  let binanceOldNumeric = null; 

  let binanceSocket = null;
  let bybitSocket = null;
  let currentPair = null; 
  let commonPairs = []; // {symbol, totalVolume, ...}

  // Update old prices every 5 seconds
  setInterval(() => {
    if (bybitCurrentNumeric !== null) {
      bybitOldNumeric = bybitCurrentNumeric;
    }
    if (binanceCurrentNumeric !== null) {
      binanceOldNumeric = binanceCurrentNumeric;
    }
  }, 5000);

  function updatePrice(el, currentNumeric, oldNumeric, displayString) {
    if (oldNumeric === null) {
      el.style.color = "#333";
    } else if (currentNumeric > oldNumeric) {
      el.style.color = "green";
    } else if (currentNumeric < oldNumeric) {
      el.style.color = "red";
    } else {
      el.style.color = "#333";
    }
    el.textContent = displayString;
  }

  async function fetchPairs() {
    const binanceResp = await fetch("https://api.binance.com/api/v3/ticker/24hr");
    const binanceData = await binanceResp.json();

    const binanceMap = {};
    for (const ticker of binanceData) {
      if (ticker.symbol.endsWith("USDT")) {
        binanceMap[ticker.symbol] = {
          symbol: ticker.symbol,
          volume: parseFloat(ticker.quoteVolume)
        };
      }
    }

    const bybitResp = await fetch("https://api.bybit.com/v5/market/tickers?category=spot");
    const bybitData = await bybitResp.json();
    const bybitTickers = bybitData.result.list;

    const bybitMap = {};
    for (const t of bybitTickers) {
      const symbol = t.symbol;
      if (symbol.endsWith("USDT")) {
        bybitMap[symbol] = {
          symbol: symbol,
          volume: parseFloat(t.volume24h)
        };
      }
    }

    const common = [];
    for (const sym in binanceMap) {
      if (bybitMap[sym]) {
        const totalVolume = binanceMap[sym].volume + bybitMap[sym].volume;
        common.push({
          symbol: sym,
          binanceVolume: binanceMap[sym].volume,
          bybitVolume: bybitMap[sym].volume,
          totalVolume: totalVolume
        });
      }
    }

    common.sort((a,b) => b.totalVolume - a.totalVolume);
    return common;
  }

  function renderPairs(pairs) {
    pairListEl.innerHTML = "";
    for (const p of pairs) {
      const li = document.createElement("li");
      const base = p.symbol.slice(0, -4);
      li.textContent = `${base}/USDT`;
      li.dataset.symbol = p.symbol;
      pairListEl.appendChild(li);
    }
  }

  function filterPairs(query) {
    const q = query.trim().toUpperCase();
    const filtered = commonPairs.filter(p => p.symbol.includes(q));
    renderPairs(filtered);
  }

  function closeSockets() {
    if (binanceSocket && binanceSocket.readyState === WebSocket.OPEN) {
      binanceSocket.close();
    }
    if (bybitSocket && bybitSocket.readyState === WebSocket.OPEN) {
      bybitSocket.close();
    }
    binanceSocket = null;
    bybitSocket = null;
  }

  function initializeSockets(pair) {
    // Reset old prices
    bybitCurrentNumeric = null;
    bybitOldNumeric = null; 
    binanceCurrentNumeric = null;
    binanceOldNumeric = null; 
    bybitPriceEl.textContent = "Loading...";
    binancePriceEl.textContent = "Loading...";
    bybitPriceEl.style.color = "#333";
    binancePriceEl.style.color = "#333";

    const binancePair = pair.toLowerCase();

    // Binance WebSocket
    binanceSocket = new WebSocket(`wss://stream.binance.com:9443/ws/${binancePair}@ticker`);
    binanceSocket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.c) {
        const priceStr = data.c;
        const priceNum = parseFloat(priceStr);
        binanceCurrentNumeric = priceNum;
        updatePrice(binancePriceEl, binanceCurrentNumeric, binanceOldNumeric, priceStr);
      }
    };
    binanceSocket.onerror = (error) => {
      console.error("Binance WebSocket error:", error);
    };

    // Bybit WebSocket
    bybitSocket = new WebSocket("wss://stream.bybit.com/v5/public/spot");
    bybitSocket.onopen = () => {
      const msg = {
        op: "subscribe",
        args: [`tickers.${pair}`]
      };
      bybitSocket.send(JSON.stringify(msg));
    };
    bybitSocket.onmessage = (event) => {
      const response = JSON.parse(event.data);
      if ((response.type === "snapshot" || response.type === "delta") && response.topic === `tickers.${pair}`) {
        if (response.data && response.data.lastPrice) {
          const priceStr = response.data.lastPrice;
          const priceNum = parseFloat(priceStr);
          bybitCurrentNumeric = priceNum;
          updatePrice(bybitPriceEl, bybitCurrentNumeric, bybitOldNumeric, priceStr);
        }
      }
    };
    bybitSocket.onerror = (error) => {
      console.error("Bybit WebSocket error:", error);
    };
  }

  // Dropdown logic
  dropdownButton.addEventListener("click", () => {
    dropdownPanel.classList.toggle("open");
    if (dropdownPanel.classList.contains("open")) {
      searchInput.value = "";
      filterPairs(""); // show all
      searchInput.focus();
    }
  });

  document.addEventListener("click", (e) => {
    if (!dropdownPanel.contains(e.target) && e.target !== dropdownButton) {
      dropdownPanel.classList.remove("open");
    }
  });

  pairListEl.addEventListener("click", (e) => {
    if (e.target.tagName === "LI") {
      const newPair = e.target.dataset.symbol;
      if (newPair && newPair !== currentPair) {
        currentPair = newPair;
        dropdownButton.textContent = e.target.textContent;
        closeSockets();
        initializeSockets(currentPair);
      }
      dropdownPanel.classList.remove("open");
    }
  });

  searchInput.addEventListener("input", () => {
    const query = searchInput.value;
    filterPairs(query);
  });

  // Initialize
  (async () => {
    commonPairs = await fetchPairs();
    if (commonPairs.length > 0) {
      renderPairs(commonPairs);
      currentPair = commonPairs[0].symbol;
      dropdownButton.textContent = `${currentPair.slice(0,-4)}/USDT`;
      initializeSockets(currentPair);
    } else {
      dropdownButton.textContent = "No common pairs";
    }
  })();
</script>
</body>
</html>
